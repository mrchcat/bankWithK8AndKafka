# Банковское приложение

Сервис представляет собой группу микросервисов, реализующих регистрацию и авторизацию пользователей, изменение
пользовательских данных, создание и удаление банковских аккаунтов в 3 валютах, операции в наличной и безналичной форме, 
просмотр динамики курсов валют.  
Безопасность обмена сообщений между микросервисами обеспечивает Keycloak, а паттерн Service Discovery и 
Externalized Config - Kubernetes.   
![](/readme/front.png)


Версия: Java 21

Зависимости: 
* Spring Boot 3.5 
* Spring Security
* Spring WebMVC
* Spring Data
* Postgres
* Keycloak
* Resilience4j
* Thymeleaf
* Maven
* JUnit 5
* Lombok

Для запуска программы на локальном компьютере необходимы: Docker, Minikube (протестирован в связке с VirtualBox 7.1), 
Helm. Приложение будет доступно по адресу \<namespace\>.bankapp.internal.com (например, "test.bankapp.internal.com") 

Порядок запуска: 
1) создайте узел Kubernetes: "minikube start --driver=virtualbox" 
(при наличии ошибок попробуйте отключить проверку и увеличить ресурсы: "minikube start --driver=virtualbox --no-vtx-check"; "minikube start --driver=virtualbox --cpus=4 --memory=30000 --no-vtx-check")
2) установите ingress: "minikube addons enable ingress"
3) в отдельном окне с правами администратора введите "minikube tunnel" и не закрывайте окно
4) получите ip aдрес ноды: "minikube ip" и добавьте его в файл hosts вместе с адресом сайта
(например, "192.168.59.107 prod.bankapp.internal.com") 
При развертывании с соответствующими настройками, приложение будет доступно по адресу "prod.bankapp.internal.com"

Значения параметров для настройки доступны в helm/values.yaml

По умолчанию доступны 3 пользователя со следующими username, паролем и правами:
'anna'/'12345'/'CLIENT'; 'boris'/'12345'/'CLIENT'; 'ivanov'/'12345'/'MANAGER'
Клиенты и менеджеры имеют доступ к главной странице, тогда как зарегистрировать нового пользователя может только
менеджер (в нашем случае это 'ivanov').
При первоначальном запуске пользователи не имеют аккаунтов, для их создания поставьте галочки напротив соответствующей валюты.   

**Общая структура микросервисов**:
![](/readme/all_micro.png)

**Схема базы данных accounts:**

![](/readme/accounts_db.png)
* users - таблица пользователей
* accounts - таблица аккаунтов
* amount_blocks - таблица заблокированных средств при совершении операций с наличными средствами. При запросе на выдачу 
определенной суммы средства сначала блокируются в таблице accounts, а затем при подтверждении выдачи - списываются со счета, 
либо блокировка просто удаляется, если клиент не забрал из банкомата деньги   
* log - таблица для записи всех совершенных операций со счетами

Более подробно схема операций выдачи денег показана на схеме
![](/readme/withdrawal.png)

**Схема базы данных cash:**

![](/readme/cash_db.png)

* cash_transactions - лог для операций с наличностью   

**Схема базы данных transfer:**

![](/readme/transfer_db.png)
* transfers - лог для безналичных операций

**Схема базы данных exchange:**

![](/readme/exchange_db.png)
* exchange_rates - курсы валют на определенную дату 

**Схема базы данных notifications:**

![](/readme/notifications_db.png)
* notifications - лог пришедших и отправленных сообщений

При коммуникации между сервисами Accounts, Cash и Transfer во избежание повторного проведения уже проведенных ранее 
операций используется UUID номер транзакции. 
Сервис проверки транзакций (blocker) подтверждает или отклоняет транзакции случайным образом.
По умолчанию вероятность подтвердить транзакцию составляет CONFIRM_PROBABILITY = 0.97%  
Контракты тестируются на примере сервиса "exchange".